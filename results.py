# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'results.ui'
#
# Created by: PyQt5 UI code generator 5.15.9
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
from workout_data import Ui_list_workout_data
from datetime import datetime
import json
import os

class Ui_results(object):

    '''
        Accepts the arguments filepath, workout_type, and time.
            -Filepath is where the workout is
            -Workout type is what workout type is in that filepath
            -Time is dependent on the final result of main_workout.py once it was finished.
    '''

    def setupUi(self, results, filepath, workout_type, time):
        
        self.filepath = filepath
        self.workout_type = workout_type
        self.time = time

        self.win = results #Window of results

        minutes, seconds = self.convert_seconds(self.time)
        print ("\nTime in seconds: ",self.time)
        print (minutes, seconds)
        self.minutes_str = str(minutes)
        self.seconds_str = str(seconds)

        weight, height, bmi, category = self.edit_bmi()
        #time_str = str(self.time)
        weight_str = str(weight)
        height_str = str(height)
        bmi_str = f"= {str(bmi)}"
        category_str = str(category)

        name = self.read_name()

        results.setObjectName("results")
        results.resize(412, 732)
        self.centralwidget = QtWidgets.QWidget(results)
        self.centralwidget.setObjectName("centralwidget")
        self.line = QtWidgets.QFrame(self.centralwidget)
        self.line.setGeometry(QtCore.QRect(0, 60, 411, 16))
        self.line.setFrameShape(QtWidgets.QFrame.HLine)
        self.line.setFrameShadow(QtWidgets.QFrame.Sunken)
        self.line.setObjectName("line")
        self.synopsis = QtWidgets.QLabel(self.centralwidget)
        self.synopsis.setGeometry(QtCore.QRect(130, 25, 161, 21))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        self.synopsis.setFont(font)
        self.synopsis.setObjectName("synopsis")
        self.line_2 = QtWidgets.QFrame(self.centralwidget)
        self.line_2.setGeometry(QtCore.QRect(0, 140, 411, 16))
        self.line_2.setFrameShape(QtWidgets.QFrame.HLine)
        self.line_2.setFrameShadow(QtWidgets.QFrame.Sunken)
        self.line_2.setObjectName("line_2")
        self.total_time = QtWidgets.QLabel(self.centralwidget)
        self.total_time.setGeometry(QtCore.QRect(30, 100, 191, 21))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        self.total_time.setFont(font)
        self.total_time.setObjectName("total_time")
        self.total_time_editable = QtWidgets.QLabel(self.centralwidget)
        self.total_time_editable.setGeometry(QtCore.QRect(250, 100, 200, 20))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.total_time_editable.setFont(font)
        self.total_time_editable.setObjectName("total_time_editable")

        self.total_time_editable.setText(f"{self.minutes_str} Mins {self.seconds_str} Secs")

        self.calendarWidget = QtWidgets.QCalendarWidget(self.centralwidget)
        self.calendarWidget.setGeometry(QtCore.QRect(20, 260, 376, 218))
        self.calendarWidget.setObjectName("calendarWidget")
        self.total_calories = QtWidgets.QLabel(self.centralwidget)
        self.total_calories.setGeometry(QtCore.QRect(30, 180, 191, 21))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        self.total_calories.setFont(font)
        self.total_calories.setObjectName("total_calories")
        self.total_calories_editable = QtWidgets.QLabel(self.centralwidget)
        self.total_calories_editable.setGeometry(QtCore.QRect(250, 180, 111, 20))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.total_calories_editable.setFont(font)
        self.total_calories_editable.setObjectName("total_calories_editable")
        self.line_3 = QtWidgets.QFrame(self.centralwidget)
        self.line_3.setGeometry(QtCore.QRect(0, 220, 411, 16))
        self.line_3.setFrameShape(QtWidgets.QFrame.HLine)
        self.line_3.setFrameShadow(QtWidgets.QFrame.Sunken)
        self.line_3.setObjectName("line_3")
        self.line_4 = QtWidgets.QFrame(self.centralwidget)
        self.line_4.setGeometry(QtCore.QRect(0, 500, 411, 16))
        self.line_4.setFrameShape(QtWidgets.QFrame.HLine)
        self.line_4.setFrameShadow(QtWidgets.QFrame.Sunken)
        self.line_4.setObjectName("line_4")
        self.line_5 = QtWidgets.QFrame(self.centralwidget)
        self.line_5.setGeometry(QtCore.QRect(0, 630, 411, 16))
        self.line_5.setFrameShape(QtWidgets.QFrame.HLine)
        self.line_5.setFrameShadow(QtWidgets.QFrame.Sunken)
        self.line_5.setObjectName("line_5")
        self.height_label = QtWidgets.QLabel(self.centralwidget)
        self.height_label.setGeometry(QtCore.QRect(50, 550, 111, 20))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.height_label.setFont(font)
        self.height_label.setObjectName("height_label")
        self.BMI_label = QtWidgets.QLabel(self.centralwidget)
        self.BMI_label.setGeometry(QtCore.QRect(190, 520, 41, 21))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.BMI_label.setFont(font)
        self.BMI_label.setObjectName("BMI_label")
        self.calendar_label = QtWidgets.QLabel(self.centralwidget)
        self.calendar_label.setGeometry(QtCore.QRect(80, 240, 261, 21))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.calendar_label.setFont(font)
        self.calendar_label.setObjectName("calendar_label")

        self.calendarWidget.clicked.connect(self.calendar_click)

        self.weight_label = QtWidgets.QLabel(self.centralwidget)
        self.weight_label.setGeometry(QtCore.QRect(50, 580, 111, 20))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.weight_label.setFont(font)
        self.weight_label.setObjectName("weight_label")
        self.bmi_final = QtWidgets.QLabel(self.centralwidget)
        self.bmi_final.setGeometry(QtCore.QRect(220, 600, 171, 20))
        font = QtGui.QFont()
        font.setPointSize(10)
        font.setBold(True)
        font.setWeight(75)
        self.bmi_final.setFont(font)
        self.bmi_final.setObjectName("bmi_final")

        self.bmi_final.setText(bmi_str + " / " + category_str)

        self.height_editable = QtWidgets.QLabel(self.centralwidget)
        self.height_editable.setGeometry(QtCore.QRect(190, 550, 150, 16))
        font = QtGui.QFont()
        font.setPointSize(10)
        font.setBold(False)
        font.setItalic(True)
        font.setWeight(50)
        self.height_editable.setFont(font)
        self.height_editable.setObjectName("height_editable")

        self.height_editable.setText(f"{height_str} cm")

        self.weight_editable = QtWidgets.QLabel(self.centralwidget)
        self.weight_editable.setGeometry(QtCore.QRect(190, 580, 150, 16))
        font = QtGui.QFont()
        font.setPointSize(10)
        font.setBold(False)
        font.setItalic(True)
        font.setWeight(50)
        self.weight_editable.setFont(font)
        self.weight_editable.setObjectName("weight_editable")

        self.weight_editable.setText(f"{weight_str} KG")

        self.button_main = QtWidgets.QPushButton(self.centralwidget)
        self.button_main.setGeometry(QtCore.QRect(262, 660, 121, 28))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        self.button_main.setFont(font)
        self.button_main.setObjectName("button_main")

        self.button_main.clicked.connect(self.back_main)

        self.greet = QtWidgets.QLabel(self.centralwidget)
        self.greet.setGeometry(QtCore.QRect(50, 665, 200, 30))
        font = QtGui.QFont()
        font.setFamily("Poppins")
        font.setPointSize(10)
        font.setBold(True)
        font.setItalic(True)
        font.setUnderline(True)
        self.greet.setFont(font)
        self.greet.setObjectName("greet")

        self.greet.setText(f"Helllo! {name}")

        results.setCentralWidget(self.centralwidget)
        self.statusbar = QtWidgets.QStatusBar(results)
        self.statusbar.setObjectName("statusbar")
        results.setStatusBar(self.statusbar)

        self.edit_workout_data(self.filepath, self.workout_type, self.minutes_str, self.seconds_str)

        print("\n Workout Data is as shown: \n")

        self.retranslateUi(results)
        QtCore.QMetaObject.connectSlotsByName(results)

    def retranslateUi(self, results):
        _translate = QtCore.QCoreApplication.translate
        results.setWindowTitle(_translate("results", "MainWindow"))
        self.synopsis.setText(_translate("results", "Workout Synopsis"))
        self.total_time.setText(_translate("results", "Total time of Workout:"))
        #self.total_time_editable.setText(_translate("results", "10 Minutes"))
        self.total_calories.setText(_translate("results", "Potential Calories Lost:"))
        self.total_calories_editable.setText(_translate("results", "100 Calories"))
        self.height_label.setText(_translate("results", "Your Height:"))
        self.BMI_label.setText(_translate("results", "BMI:"))
        self.calendar_label.setText(_translate("results", "Calendar of Days Worked Out"))
        self.weight_label.setText(_translate("results", "Your Weight:"))
        #self.bmi_final.setText(_translate("results", "= Index / Category"))
        #self.height_editable.setText(_translate("results", "Draft"))
        #self.weight_editable.setText(_translate("results", "Draft"))
        self.button_main.setText(_translate("results", "Back to Main"))

    def back_main(self):
        self.win.close()
        #self.add_workout_data()
        #self.edit_workout_data(self.filepath, self.workout_type)
        
    #A more convenient way to read profiles. I forgot about return functions.
    #Finds profile with the status "active" and refers to it as editing mode.
    #https://python.hotexamples.com/examples/ui_mainwindow/Ui_MainWindow/setupUi/python-ui_mainwindow-setupui-method-examples.html
    def read_status(self):
        file_path = "profiles"
        active_profile = None
        for file in os.listdir(file_path):
            if file.endswith(".json"):
                with open(os.path.join(file_path, file)) as f:
                    profile = json.load(f)
                    if profile["status"] == "active":
                        active_profile = file
        return active_profile #Return the profile with the active status
    
    def read_name(self):
        profile = f"profiles/{self.read_status()}" #Gets the profile with active status
        with open(profile, 'r') as f:
            json_object = json.load(f)
            name = json_object["info"]["name"]
        return name
    
    #Accepts the argument "seconds" which is dependent to the seconds last main_workout.py
    def convert_seconds(self, seconds):
        minutes = seconds // 60
        seconds = seconds % 60

        #Round to the nearest whole number
        minutes = round(minutes)
        seconds = round(seconds)

        return minutes, seconds #returns in the form of {value} minutes and {value} seconds

    #A method to edit BMI and get attributes from JSON
    def edit_bmi(self):
        profile = f"profiles/{self.read_status()}" #Gets the profile with active status

        with open(profile, 'r') as f:
            json_object = json.load(f)
            weight = round(json_object["info"]["weight"], 2)
            height = round(json_object["info"]["height"], 2)

        #Get BMI with height in CM formula
        bmi = round(weight / (height / 100)**2, 2)

        #Get BMI category
        category = None
        if bmi < 18.5:
            category = "Underweight"
        elif bmi < 25:
            category = "Normal"
        elif bmi < 30:
            category = "Overweight"
        elif bmi < 35:
            category =  "Obese I"
        elif bmi < 40:
            category = "Obese II"
        else:
            category = "Obese III"

        return weight, height, bmi, category
    
    def write(self, data, filename):
        with open(filename, "w") as f:
            json.dump(data, f, indent=4)

    def edit_workout_data(self, filepath, workout_type, minutes, seconds):
        filename = f"profiles/{self.read_status()}"
        self.filename = filename
        filepath = self.filepath
        workout_type = self.workout_type
        self.minutes = minutes
        self.seconds = seconds

        with open(filename) as json_file:
            data = json.load(json_file)
            temp = data["workout_data"]

            #Formats the datetime object into a string with the specified format
            current_date_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S") #Years, Months, Date, Hours, Mins, Second
            current_date = current_date_time.split()[0] #Assigns the first substring
            current_time = current_date_time.split()[1] #Assigns the second substring

            new_data = {
                current_date: {
                    "Time": current_time,
                    "Type": f"{workout_type}",
                    "Duration": f"{self.minutes_str} Mins {self.seconds_str} Secs",
                    "Calories Burnt": "100 Calories"
                }
            }

            temp.append(new_data)
            data["workout_data"] = temp

            self.write(data, filename)         

    def calendar_click(self, date):
        print('Calendar clicked:', date.toString())
        self.window = QtWidgets.QMainWindow()
        self.ui = Ui_list_workout_data()
        self.ui.setupUi(self.window, self.filename)
        self.window.show()
           

if __name__ == "__main__":
    try:
        import sys
        app = QtWidgets.QApplication(sys.argv)
        results = QtWidgets.QMainWindow()
        ui = Ui_results()
        ui.setupUi(results)
        results.show()
        sys.exit(app.exec_())
    except FileNotFoundError:
        print("No Files are Active.")